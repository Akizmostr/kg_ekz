<!-- (C) 2017 Хаджинова Н.В., каф. ИТАС, БГУИР -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//RU">
<HTML>
<HEAD>
<LINK rel=stylesheet href="lb2/Оболочка/css/style.css" type=text/css>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<META HTTP-EQUIV="Content-Language" CONTENT="ru">
<title>Лекция № 14 &quot;Методы закраски&quot;</title>
</head>

<body>
<div align="center">
  <h1>Лекция № 14 &quot;<strong>Методы закраски</strong>&quot; </h1>
</div>
<hr>
<h2>Темы, рассматриваемые в данной лекции: </h2>
<ol>
  <li>Диффузное отражение и рассеянный свет.</li>
  <li>Зеркальное отражение.</li>
  <li>Однотонная закраска полигональной сетки.</li>
  <li>Метод Гуро.</li>
  <li>Метод Фонга.</li>
  <li>Тени.</li>
  <li>Поверхности, пропускающие свет. Детализация поверхностей.<hr>
  </li>
</ol>
<h1><a name="_Toc195990543">1. ПРОСТАЯ МОДЕЛЬ ОСВЕЩЕНИЯ</a></h1>
<p>Световая энергия,  падающая на поверхность, может быть поглощена, отражена или пропущена. Частично  она поглощается и превращается в тепло, а частично отражается или пропускается.  Объект можно увидеть, только если он отражает или пропускает свет; если же  объект поглощает весь падающий свет, то он невидим и называется &laquo;абсолютно  черным телом&raquo;. Количество поглощенной, отраженной или пропущенной энергии  зависит от длины волны света. При освещении белым светом, котором интенсивность  всех длин волн снижена примерно одинаково, объект выглядит серым. Если  поглощается почти весь свет, то объект кажется черным, а если только небольшая  его часть &ndash; белым. Если поглощаются лишь определенные длины волн, то у света,  исходящего от объекта, изменяется распределение энергии и объект выглядит  цветным. Цвет объекта определяется поглощаемыми длинами волн.<br>
Свойства отраженного  света зависят от строения, направления и формы источника света, от ориентации и  свойств поверхности. Отраженный от объекта свет может также быть <em>диффузным</em> или <em>зеркальным</em>. Диффузное отражение света происходит, когда свет как бы  проникает под поверхность объекта, поглощается, а затем вновь испускается. При  этом положение наблюдателя на имеет значения, так как диффузно отраженный свет  рассеивается равномерна по всем направлениям. Зеркальное отражение происходит  от внешней поверхности объекта.</p>
<h2><a name="_Toc195990545">1.1. Диффузное отражение</a></h2>
<p>&nbsp;</p>
<p>Свет точечного  источника отражается от идеального рассеивателя по закону Ламберта:  интенсивность отраженного света пропорциональна косинусу угла между  направлением света и нормалью к поверхности, т.е.</p>
<p align="center"><br>
  <img width="171" height="41" src="lk14_clip_image002.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.1)</p>
<p><br>
  где <em>I</em> &ndash; интенсивность отраженного света, <em>Il</em> &ndash; интенсивность точечного  источника, <em>kd</em> &ndash;  коэффициент диффузного отражения (<em>0 </em><em>&pound;</em><em> kd </em><em>&pound;</em><em> 1</em>), <em>q</em> &ndash; угол между направлением света и нормалью к  поверхности (см. рис. 8.1). Если <em>q</em><em> &gt; </em><em>p</em><em>/2</em>, то источник света расположен за объектом.  Коэффициент диффузного отражения <em>kd</em> зависит от материала и длины волны света, но в простых моделях освещения обычно  считается постоянным.</p>
<p align="center"><img width="302" height="190" src="lk14_clip_image004.jpg" alt="r_8_1"><br>
  Рисунок  8.1 &ndash; Диффузное отражение</p>
<p>Поверхность  предметов, изображенных при помощи простой модели освещения с ламбертовым  диффузным отражением, выглядит блеклой и матовой. Предполагается, что источник  точечный, поэтому объекты, на которые на падает прямой свет, кажутся черными.  Однако на объекты реальных сцен падает еще и рассеянный свет, отраженный от  окружающей обстановки, например от стен комнаты. Рассеянному свету  соответствует распределенный источник. Поскольку для расчета таких источников  требуются большие вычислительные затраты, в машинной графике они заменяются на  коэффициент рассеяния &ndash; константу</p>
<p align="center"><br>
  <img width="217" height="41" src="lk14_clip_image006.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.2)</p>
<p><br>
  где <em>Ia</em> &ndash; интенсивность  рассеянного света, <em>ka</em> &ndash;  коэффициент диффузного отражения рассеянного света (<em>0 </em><em>&pound;</em><em> ka </em><em>&pound;</em><em> 1</em>).<br>
  Пусть даны два  объекта, одинаково ориентированные относительно источника, но расположенные на  разном расстоянии от него. Интенсивности рассчитанные по формуле (8.1) будут  одинаковыми. Это значит, что когда объекты перекрываются их невозможно  различить, хотя интенсивность света обратно пропорциональна квадрату расстояния  от источника, и объект, лежащий дальше от него, должен быть темнее. Если  расстояние стремится к бесконечности, то диффузный член стремится к нулю. В  случае перспективного преобразования сцены в качестве коэффициента  пропорциональности для диффузного члена можно взять расстояние <em>d</em> от центра проекции до объекта. Но если  центр проекции лежит близко к объекту, то 1/d2 изменяется очень быстро, т.е. у  объектов, лежащих примерно на одинаковом расстоянии от источника, разница  интенсивностей чрезмерно велика.<br>
  Как показывает опыт,  большей реалистичности можно добиться при линейном затухании. В этом случае  модель освещения выглядит так:</p>
<p align="center"><br>
  <img width="221" height="43" src="lk14_clip_image008.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.3)</p>
<p><br>
  где K &ndash; произвольная  постоянная.<br>
  Если предполагается.  Что точка наблюдения находится в бесконечности, то d определяется положением  объекта, ближайшего к точке наблюдения. Это означает. Что ближайший объект  освещается с полной интенсивностью источника, а более далекие &ndash; с уменьшенной.  Для цветных поверхностей модель освещения применяется к каждомуиз трех основных  цветов.</p>
<h2><a name="_Toc195990546">1.2. Зеркальное отражение</a></h2>
<p>Интенсивность  зеркально отраженного света зависит от угла падения, длины волны падающего  света и свойств вещества. Зеркальное отражение света является направленным.  Угол отражения от идеальной отражающей поверхности (зеркала) равен углу  падения. Если поверхность неидеальна, то количество света, достигающее  наблюдателя, зависит от пространственного распределения зеркально отраженного  света. У гладких поверхностей распределение узкое или сфокусированное, у  шероховатых &ndash; более широкое.<br>
  Благодаря  зеркальному отражению на блестящих предметах появляются световые блики. Из-за  того, что зеркально отраженный свет сфокусирован вдоль вектора отражения, блики  при движении наблюдателя тоже перемещаются. Более того, так как свет отражается  от внешней поверхности (за исключением металлов и некоторых твердых  красителей), то отраженный луч сохраняет свойства падающего. Например, при  освещении блестящей синей поверхности белым светом, возникают белые, а не синие  блики.<br>
  В простых моделях  освещения обычно используется эмпирическая модель Фонга, так как физические  свойства зеркального отражения очень сложны. Модель Фонга имеет вид:</p>
<p align="center"><img width="154" height="30" src="lk14_clip_image010.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.4)</p>
<p>где <em>w(i, </em><em>l</em><em>)</em> &ndash; кривая отражения, представляющая отношение  зеркально отраженного света к падающему как функцию угла падения <em>i</em> и длины волны <em>l</em>; <em>n</em> &ndash; степень аппроксимирующая пространственное распределение зеркально отраженного  света. Большие значения <em>n</em> дают  сфокусированное пространственное распределения характеристик металлов и других  блестящих поверхностей, малые &ndash; более широкие распределения для неметаллических  поверхностей, например бумаги.</p>
<p align="center"><br>
  <img width="302" height="189" src="lk14_clip_image012.jpg" alt="r_8_2"> <br>
  Рисунок  8.2 &ndash; Зеркальное отражение</p>
<p>Коэффициент  зеркального отражения зависит от угла падения, однако даже при перпендикулярном  падении зеркально отражается только часть света, а остальное либо поглощается,  либо отражается диффузно. Эти соотношения определяются свойствами вещества и  длиной волны. Коэффициент отражения для некоторых неметаллов может быть всего  4%, в то время как для металлических материалов &ndash; более 80%</p>
<h2><a name="_Toc195990547">1.3. Общая модель освещения</a></h2>
<p>&nbsp;</p>
<p>Объединяя формулы  рассеянного света, диффузного и зеркального отражения можно получить общую  модель освещения</p>
<p align="center"><img width="285" height="43" src="lk14_clip_image014.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.5)</p>
<p>Функция <em>w(i, </em><em>l</em><em>)</em> довольно сложна, поэтому ее обычно заменяют константой <em>ks</em>, которая либо выбирается  из эстетических соображений, либо определяется экспериментально. Таким образом</p>
<p align="center"><img width="259" height="43" src="lk14_clip_image016.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.6)</p>
<p>В машинной графике  эта модель часто называется функцией закраски и применяется для расчета  интенсивности или тона точек объекта или пикселов изображения. Чтобы получить  цветное изображение, нужно найти функции закраски для каждого из трех основных  цветов. Константа <em>ks</em> обычно одинакова для всех трех основных цветов, поскольку цвет зеркально  отраженного света определяется цветом падающего. Если имеется несколько  источников света, то их эффекты суммируются. В этом случае модель освещения  определяется как</p>
<p align="center"><img width="325" height="56" src="lk14_clip_image018.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.7)</p>
<p>где <em>m</em> &ndash; количество  источников.<br>
  Применяя формулы  скалярного произведения двух векторов, запишем</p>
<p align="center"><img width="128" height="47" src="lk14_clip_image020.gif"></p>
<p>где <em>n</em> и <em>L</em> &ndash; единичные векторы соответственно нормали к поверхности и направления к  источнику.<br>
  Аналогично</p>
<p align="center"><img width="133" height="47" src="lk14_clip_image022.gif"></p>
<p>где <em>R</em> и <em>S</em> &ndash; единичные векторы, определяющие направления отраженного луча и наблюдения.  Следовательно, модель освещения для одного источника определяется как</p>
<p align="center"><img width="291" height="47" src="lk14_clip_image024.gif">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (8.8)</p>
<p>&nbsp;</p>
<h2><a name="_Toc195990548">1.4. Определение вектора нормали к поверхности</a></h2>
<p>Из предыдущего  раздела видно, что нормаль к поверхности представляет ее локальную кривизну, а  следовательно, и направление зеркального отражения. Если известно аналитическое  описание поверхности, то нормаль вычисляется непосредственно. Но для многих  поверхностей бывает задана лишь их полигональная аппроксимация. Зная уравнение  поверхности каждой грани, можно найти направление внешней нормали.<br>
  Во многих алгоритмах  удаления невидимых линий и поверхностей используются только ребра или вершины,  поэтому, для того чтобы объединить их с моделью освещения, необходимо знать  приближенное значение нормали на ребрах и в вершинах. Пусть заданы уравнения  плоскостей полигональных граней, тогда нормаль к их общей вершине равна  среднему значению нормалей ко всем многоугольникам, сходящимся в этой вершине.  На рисунке 8.3 направление приближенной нормали в точке V1 есть</p>
<p><strong>n</strong>V1 = (a0 + a1 + a4)<strong>i</strong> + (b0 + b1 + b4)<strong>j</strong> + (c0 + c1 + c4)<strong>k</strong></p>
<p>где a0, a1, a4, b0, b1, b4, c0, c1, c4 &ndash; коэффициенты  уравнений плоскостей трех многоугольников P0, P1, P4, окружающих V1. Если требуется найти только направление  нормали, то делить результат на количество граней необязательно.</p>
<p align="center"><img width="320" height="160" src="lk14_clip_image026.jpg"> <br>
  Рисунок 8.3 &ndash; Аппроксимация нормали к  полигональной поверхности</p>
<p>Если же уравнения  плоскостей не заданы, то нормаль к вершине можно определить, усредняя векторные  произведения всех ребер, пересекающихся в вершине. Для вершины V1 на  рисунке 8.3 вектор нормали будет равен</p>
<p><strong>n</strong>V1 = V1V2&times;V1V4 + V1V5&times;V1V2 + V1V4&times;V1V5 </p>
<p>Следует обратить  внимание, что необходимы только внешние нормали. Кроме того величина нормали  зависит от количества и площади конкретных многоугольников, а также от  количества и длины конкретных ребер. Сильнее проявляется влияние  многоугольников с большей площадью и более длинных ребер.</p>
<h2><a name="_Toc195990549">1.5. Прозрачность и тени</a></h2>
<p>&nbsp;</p>
<p>В основных моделях  освещения и алгоритмах удаления невидимых линий и поверхностей рассматриваются  только непрозрачные поверхности и объекты. Однако существуют и прозрачные  объекты, пропускающие свет, например, такие, как стакан, ваза, окно автомобиля,  вода. При переходе из одной среды в другую, например, из воздуха в воду.  Световой луч преломляется, поэтому торчащая из воды палка кажется согнутой.  Преломление рассчитывается по закону Снеллиуса, который утверждает. Что  падающий и преломленный лучи лежат в одной плоскости, а углы падения и  преломления связаны формулой</p>
<p align="center"><img width="127" height="23" src="lk14_clip_image028.gif"></p>
<p>где <em>h</em><em>1</em> и <em>h</em><em>2</em> &ndash; показатели преломления двух сред, <em>q</em><em>1</em> &ndash; угол падения, <em>q</em><em>2</em> &ndash; угол преломления (рисунок 8.4). Ни одно вещество не пропускает весь  падающий свет, часть его всегда отражается; это также показано на рисунке 8.4.</p>
<p align="center"><img width="480" height="320" src="lk14_clip_image030.jpg"> <br>
  Рисунок 8.4 &ndash; Геометрия преломления</p>
<p align="center">Так же, как и  отражение, пропускание может быть зеркальным (направленным) или диффузным.  Направленное пропускание свойственно прозрачным веществам, например стеклу.  Если смотреть на объект сквозь такое вещество, то, за исключением контурных  линий криволинейных поверхностей, искажения происходить не будет. Если свет при  пропускании через вещество рассеивается, то имеет место диффузное пропускание.  Если смотреть на объект сквозь такое вещество, то он будет выглядеть нечетким  или искаженным.<br>
  Нечто похожее  происходит при встраивании перспективного преобразования в видовое  преобразование. Обычно перспективное преобразование проводится для того, чтобы  получить искаженный объект, который затем строится в аксонометрической проекции  с точкой наблюдения удаленной в бесконечность (рисунок 8.5). На рисунке 8.5,а  луч, исходящий из точки <em>P</em>, пересекает  неискаженный объект в точке <em>i</em> и после  преломления попадает в точку <em>b</em> плоскости фона. На рис. 8.5,б показан объект после перспективного  преобразования. Теперь луч пересекает объект в преобразованной точке <em>i'</em>, преломленный луч пересекается с  фоном в точке <em>b'</em> с противоположной  стороны от центральной линии. Это происходит из-за неправильных угловых  соотношений между искаженным (преобразованным) объектом и искаженным  (преломленным) лучом.<br>
  <img width="480" height="480" src="lk14_clip_image032.jpg"> <br>
  Рисунок 8.5 &ndash; Влияние перспективы на преломление:  а) неискаженное, б) с перспективным искажением</p>
<p>Для того чтобы  устранить влияние преломления, можно либо применять алгоритмы, работающие в  пространстве объекта, либо пользовать специальными преобразованиями между  пространствами объекта и изображения.<br>
  В простейших  реализациях эффекты прозрачности преломления вообще не рассматриваются, и  явления, показанные на рисунке 8.5, не учитываются. Простое пропускание света  можно встроить в любой алгоритм удаления невидимых линий и поверхностей.<br>
  Прозрачные многоугольники  или поверхности помечаются, и если видимая грань прозрачна, то в буфер кадра  записывается линейная комбинация двух ближайших поверхностей. При этом  интенсивность</p>
<p align="center"><img width="183" height="23" src="lk14_clip_image034.gif"></p>
<p>где <em>I1</em> &ndash; видимая поверхность, <em>I2</em> &ndash; поверхность, расположенная  непосредственно за ней, <em>t</em> &ndash;  коэффициент прозрачности <em>I1</em>.  Если поверхность совершенно прозрачна, то <em>t  = 0</em>, а если непрозрачна, то <em>t = 1</em>.  Если <em>I2</em> тоже прозрачна, то  алгоритм применяется рекуррентно, пока не встретится непрозрачная поверхность  или фон.<br>
  Для криволинейных  поверхностей, например, таких, как ваза или стакан, линейной аппроксимации  недостаточно, так как вблизи контурных линий прозрачность уменьшается из-за  толщины материала. Чтобы точнее изобразить это явление, Кэй предложил несложную  нелинейную аппроксимацию на основе <em>z</em>-составляющей нормали к поверхности</p>
<p align="center"><img width="219" height="27" src="lk14_clip_image036.gif"></p>
<p>где <em>tmin</em> и <em>tmax</em> &ndash; минимальная и максимальная прозрачность  объекта, <em>nz</em> &ndash; <em>z</em>-составляющая единичной нормали к  поверхности, <em>p</em> &ndash; коэффициент степени прозрачности, <em>t</em> &ndash; коэффициент прозрачности точки объекта.<br>
  Для того чтобы  включить преломление в модель освещения, нужно при построении видимых  поверхностей учитывать не только падающий, но и отраженный и пропущенный свет.  Обычно рассматриваются только зеркально отраженные и пропущенные лучи, так как  диффузное отражение от просвечивающих поверхностей порождает бесконечное  количество беспорядочно ориентированных лучей. Поэтому моделируются только  прозрачные вещества, для которых формула расчета интенсивности является простым  расширением ранее описанных моделей. Ее общий вид:</p>
<p align="center"><img width="177" height="24" src="lk14_clip_image038.gif"></p>
<p>Если положения  наблюдателя и источника света совпадают, то теней не видно, но они появляются,  когда наблюдатель перемещается в любую другую точку. Изображение с построенными  тенями выглядит гораздо реалистичнее.<br>
  Наблюдения  показывают, что тень состоит из двух частей: полутени и полной тени. Полная  тень &ndash; это центральная, темная, резко очерченная часть, а полутень &ndash; окружающая  ее более светлая часть. В машинной графике обычно рассматриваются точечные  источники, создающие только полную тень. Распределенные источники света  конечного размера создают как полную тень, так и полутень: в полной тени свет  вообще отсутствует, а полутень освещается частью распределенного источника.  Из-за больших вычислительных затрат, как правило, рассматривается только полная  тень, образуемая точечным источником света.<br>
  Для того чтобы  построить тени, нужно по существу дважды удалить невидимые поверхности: для  положения каждого источника и для положения наблюдателя или точки наблюдения,  т.е. это двухшаговый процесс.<br>
  В общем случае тени  образуются двояко: это собственная тень и проекционная. Собственная тень  получается тогда, когда сам объект препятствует попаданию света на некоторые  его грани. При этом алгоритм построения собственных теней аналогичен алгоритму  удаления нелицевых граней: грани, затененные собственной тенью, являются  нелицевыми, если точку наблюдения совместить с источником света.<br>
  Если один объект  препятствует попадпнию света на другой, то получается проекционная тень. Чтобы  найти такие тени, нужно построить проекции всех нелицевых граней на сцену.  Центр проекции находится в источнике света. Точки пересечения проецируемой  грани со всеми другими плоскостями образуют многоугольники, которые помечаются  как теневые многоугольники и заносятся в структуру данных.</p>
<p><strong>Дополнительно изучить</strong> материал на <a href="../../extra_books/Компьютерная графика_С.М. Брундасов.pdf">стр. 209-228 Учебного пособия С.М. Брундасова &quot;Компьютерная графика&quot;</a></p>
</body>
</html>
